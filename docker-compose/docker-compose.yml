services:
  db:
    image: postgres:16-alpine
    container_name: webapp-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: webapp
      POSTGRES_USER: webapp
      POSTGRES_PASSWORD: webapp
      PGDATA: /var/lib/postgresql/data
      REPLICATION_USER: replicator
      REPLICATION_PASSWORD: replicator
    ports:
      - "5432:5432"
    volumes:
      - ./db:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d:ro
      - ./db/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
    command:
      - "postgres"
      - "-c"
      - "hba_file=/etc/postgresql/pg_hba.conf"
      - "-c"
      - "listen_addresses=*"
      - "-c"
      - "wal_level=replica"
      - "-c"
      - "max_wal_senders=10"
      - "-c"
      - "max_replication_slots=10"
      - "-c"
      - "hot_standby=on"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U webapp -d webapp"]
      interval: 5s
      timeout: 5s
      retries: 10
  db-replica:
    image: postgres:16-alpine
    container_name: webapp-db-replica
    restart: unless-stopped
    environment:
      POSTGRES_USER: webapp
      POSTGRES_PASSWORD: webapp
      POSTGRES_DB: webapp
      PGDATA: /var/lib/postgresql/data
      REPLICATION_USER: replicator
      REPLICATION_PASSWORD: replicator
      PGPASSWORD: replicator
    ports:
      - "5433:5432"
    volumes:
      - ./db-replica:/var/lib/postgresql/data
      - ./db-replica/init:/docker-entrypoint-initdb.d:ro
    command:
      - "sh"
      - "-c"
      - |
        DATA_DIR="$${PGDATA:-/var/lib/postgresql/data}";
        if [ ! -s "$${DATA_DIR}/PG_VERSION" ]; then
          until pg_isready -h db -U "$${REPLICATION_USER}" -d "$${POSTGRES_DB}"; do
            sleep 1;
          done;
          rm -rf "$${DATA_DIR:?}"/*;
          pg_basebackup -h db -D "$${DATA_DIR}" -U "$${REPLICATION_USER}" -v -P --wal-method=stream;
          echo "primary_conninfo = 'host=db port=5432 user=$${REPLICATION_USER} password=$${REPLICATION_PASSWORD}'" >> "$${DATA_DIR}/postgresql.auto.conf";
          touch "$${DATA_DIR}/standby.signal";
        fi;
        chown -R postgres:postgres "$${DATA_DIR}";
        chmod 700 "$${DATA_DIR}";
        exec su-exec postgres postgres -c hot_standby=on
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U replicator -d webapp"]
      interval: 5s
      timeout: 5s
      retries: 10
  db-replication-init:
    image: postgres:16-alpine
    container_name: webapp-db-replication-init
    restart: "no"
    environment:
      POSTGRES_DB: webapp
      POSTGRES_USER: webapp
      POSTGRES_PASSWORD: webapp
      REPLICATION_USER: replicator
      REPLICATION_PASSWORD: replicator
      PGPASSWORD: webapp
    command:
      - "sh"
      - "-c"
      - |
        until pg_isready -h db -U "$${POSTGRES_USER}" -d "$${POSTGRES_DB}"; do
          sleep 1;
        done;
        psql -h db -U "$${POSTGRES_USER}" -d "$${POSTGRES_DB}" -v ON_ERROR_STOP=1 <<-EOSQL
        DO \$\$
        BEGIN
          IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = '$${REPLICATION_USER}') THEN
            CREATE ROLE $${REPLICATION_USER} WITH REPLICATION LOGIN PASSWORD '$${REPLICATION_PASSWORD}';
          END IF;
        END
        \$\$;
        EOSQL
    depends_on:
      db:
        condition: service_healthy
  pgadmin:
    image: dpage/pgadmin4:8
    container_name: webapp-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@localtest.me
      PGADMIN_DEFAULT_PASSWORD: admin123
    ports:
      - "5050:80"
    volumes:
      - ./pgadmin:/var/lib/pgadmin
    depends_on:
      db:
        condition: service_healthy
  solr:
    image: solr:9
    container_name: webapp-solr
    restart: unless-stopped
    command: ["solr-precreate", "catalog"]
    ports:
      - "8983:8983"
    volumes:
      - ./solr:/var/solr
  prometheus:
    image: prom/prometheus:v2.53.1
    container_name: webapp-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/data:/prometheus
    extra_hosts:
      - "host.docker.internal:host-gateway"
  grafana:
    image: grafana/grafana:11.2.0
    container_name: webapp-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
      - loki
  loki:
    image: grafana/loki:3.1.2
    container_name: webapp-loki
    restart: unless-stopped
    ports:
      - "3100:3100"
    command: ["-config.file=/etc/loki/loki.yml"]
    volumes:
      - ./loki/loki.yml:/etc/loki/loki.yml:ro
      - ./loki/data:/loki
  promtail:
    image: grafana/promtail:3.1.2
    container_name: webapp-promtail
    restart: unless-stopped
    command: ["-config.file=/etc/promtail/promtail.yml"]
    volumes:
      - ./promtail/promtail.yml:/etc/promtail/promtail.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./promtail/positions:/positions
    depends_on:
      - loki
  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: webapp-mailhog
    restart: unless-stopped
    ports:
      - "8025:8025" # UI
      - "1025:1025" # SMTP
  clamav:
    image: clamav/clamav:1.4
    container_name: webapp-clamav
    restart: unless-stopped
    ports:
      - "3310:3310"
    volumes:
      - ./clamav:/var/lib/clamav
