<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:app="http://partsvibe.app/ui-components"
      th:replace="~{layout/base :: layout(~{::title}, ~{::section})}">
<head>
  <title th:text="#{admin.users.title}">User Management</title>
</head>
<section th:replace="~{layout/admin :: body(~{::div})}">
  <div>
    <h1 class="h4 mb-3" th:text="#{admin.users.heading}">User Management</h1>

    <div class="alert mb-3"
         th:if="${actionMessageCode != null}"
         th:classappend="${actionMessageLevel != null ? actionMessageLevel : 'alert-success'}"
         th:text="${actionMessageArgs != null and #arrays.length(actionMessageArgs) > 0
                  ? #messages.msg(actionMessageCode, actionMessageArgs[0])
                  : #messages.msg(actionMessageCode)}">
      Action completed.
    </div>

    <div class="card mb-4">
      <div class="card-header" th:text="#{admin.users.filters.title}">Filters</div>
      <div class="card-body">
        <form method="get" th:action="@{/admin/users}">
          <input type="hidden" name="page" value="1" />
          <input type="hidden" name="size" th:value="${filters.size}" />
          <input type="hidden" name="sortBy" th:value="${filters.sortBy}" />
          <input type="hidden" name="sortDir" th:value="${filters.sortDir}" />
          <div class="row g-3 align-items-start">
            <div class="col-12 col-md-6 col-xl-3">
              <label class="form-label mb-1" for="usernameFilter" th:text="#{admin.users.filters.username}">
                Username
              </label>
              <input id="usernameFilter"
                     type="text"
                     class="form-control"
                     name="usernameContains"
                     th:value="${filters.usernameContains}" />
            </div>

            <div class="col-12 col-md-6 col-xl-3">
              <label class="form-label mb-1" for="enabledFilter" th:text="#{admin.users.filters.enabled}">
                Status
              </label>
              <select id="enabledFilter" class="form-select" name="enabledIs">
                <option value=""
                        th:selected="${filters.enabledIs == null}"
                        th:text="#{admin.users.filters.enabled.all}">All</option>
                <option value="true"
                        th:selected="${filters.enabledIs == true}"
                        th:text="#{admin.users.filters.enabled.enabled}">Enabled</option>
                <option value="false"
                        th:selected="${filters.enabledIs == false}"
                        th:text="#{admin.users.filters.enabled.disabled}">Disabled</option>
              </select>
            </div>

            <div class="col-12 col-md-6 col-xl-3">
              <label class="form-label mb-1" th:text="#{admin.users.filters.roles}">
                Roles
              </label>
              <div class="border rounded p-2 bg-body-tertiary">
                <div class="form-check" th:each="role : ${availableRoles}">
                  <input class="form-check-input"
                         type="checkbox"
                         name="rolesContainAll"
                         th:id="|roleFilter-${role}|"
                         th:value="${role}"
                         th:checked="${filters.rolesContainAll.contains(role)}" />
                  <label class="form-check-label" th:for="|roleFilter-${role}|"
                         th:text="${role}">ROLE_USER</label>
                </div>
              </div>
            </div>

            <div class="col-12 d-flex justify-content-end gap-2">
              <a class="btn btn-secondary" th:href="@{/admin/users}" th:text="#{admin.users.filters.clear}">
                Clear
              </a>
              <button type="submit" class="btn btn-primary" th:text="#{admin.users.filters.search}">
                Search
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-end mb-3 gap-3 flex-wrap">
      <form method="get" th:action="@{/admin/users}" class="d-flex align-items-center gap-2">
        <input type="hidden" name="page" value="1" />
        <th:block th:replace="~{admin/users-fragments :: stateHiddenFields(${hiddenFieldsForPageSize})}"></th:block>
        <label class="form-label mb-0 text-nowrap" for="sizeFilterTop" th:text="#{admin.users.filters.pageSize}">
          Page size
        </label>
        <select id="sizeFilterTop" class="form-select w-auto" name="size" onchange="this.form.submit()">
          <option th:each="pageSize : ${pageSizes}"
                  th:value="${pageSize}"
                  th:selected="${filters.size == pageSize}"
                  th:text="${pageSize}">10</option>
        </select>
      </form>

      <a class="btn btn-success" th:href="${filters.toUserCreateUrl()}">
        <i class="bi bi-plus-lg me-2" aria-hidden="true"></i>
        <span th:text="#{admin.users.actions.addUser}">Add User</span>
      </a>
    </div>

    <div class="table-responsive-md">
      <table class="table table-striped table-hover align-middle">
        <thead>
        <tr>
          <th scope="col">
            <a class="link-body-emphasis text-decoration-none" th:href="${sortUsername.url}">
              <span th:text="#{admin.users.grid.username}">Username</span>
              <th:block th:replace="~{admin/users-fragments :: sortIcon(${sortUsername})}"></th:block>
            </a>
          </th>
          <th scope="col">
            <a class="link-body-emphasis text-decoration-none" th:href="${sortEnabled.url}">
              <span th:text="#{admin.users.grid.enabled}">Status</span>
              <th:block th:replace="~{admin/users-fragments :: sortIcon(${sortEnabled})}"></th:block>
            </a>
          </th>
          <th scope="col" th:text="#{admin.users.grid.roles}">Roles</th>
          <th scope="col" class="text-end" th:text="#{admin.users.grid.actions}">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:if="${#lists.isEmpty(users)}">
          <td colspan="4" class="text-center text-muted py-4">
            <div th:text="#{admin.users.grid.empty}">No users found.</div>
            <small th:text="#{admin.users.grid.emptyHint}">Try changing filters.</small>
          </td>
        </tr>
        <tr th:each="user : ${users}">
          <td th:text="${user.username}">username</td>
          <td>
            <span class="badge text-bg-success" th:if="${user.enabled}" th:text="#{admin.users.status.enabled}">
              Enabled
            </span>
            <span class="badge text-bg-secondary" th:unless="${user.enabled}" th:text="#{admin.users.status.disabled}">
              Disabled
            </span>
          </td>
          <td th:text="${user.rolesDisplay()}">ROLE_USER</td>
          <td class="text-end">
            <div class="dropdown">
              <button class="btn btn-sm btn-link link-secondary text-decoration-none dropdown-toggle p-0"
                      type="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                      th:text="#{admin.users.grid.actions}">
                Actions
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" th:href="${filters.toUserViewUrl(user.id)}">
                    <i class="bi bi-person me-2" aria-hidden="true"></i>
                    <span th:text="#{admin.users.actions.view}">View</span>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" th:href="${filters.toUserEditUrl(user.id)}">
                    <i class="bi bi-pencil-square me-2" aria-hidden="true"></i>
                    <span th:text="#{admin.users.actions.edit}">Edit</span>
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li th:if="${user.enabled}">
                  <form method="post" class="m-0" th:action="@{/admin/users/{id}/do-lock(id=${user.id})}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <th:block th:replace="~{admin/users-fragments :: stateHiddenFields(${hiddenFieldsForActions})}"></th:block>
                    <button type="submit" class="dropdown-item">
                      <i class="bi bi-lock me-2" aria-hidden="true"></i>
                      <span th:text="#{admin.users.actions.lock}">Lock</span>
                    </button>
                  </form>
                </li>
                <li th:unless="${user.enabled}">
                  <form method="post" class="m-0" th:action="@{/admin/users/{id}/do-unlock(id=${user.id})}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <th:block th:replace="~{admin/users-fragments :: stateHiddenFields(${hiddenFieldsForActions})}"></th:block>
                    <button type="submit" class="dropdown-item">
                      <i class="bi bi-unlock me-2" aria-hidden="true"></i>
                      <span th:text="#{admin.users.actions.unlock}">Unlock</span>
                    </button>
                  </form>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <button type="button"
                          class="dropdown-item text-danger"
                          data-bs-toggle="modal"
                          th:attr="data-bs-target=|#delete-user-${user.id}|">
                    <i class="bi bi-trash me-2" aria-hidden="true"></i>
                    <span th:text="#{admin.users.actions.delete}">Delete</span>
                  </button>
                </li>
              </ul>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <app:pagination app:data="${pageInfo}" />

    <th:block th:each="user : ${users}">
      <app:confirmation-dialog app:data="${deleteDialogsByUserId[user.id]}">
        <th:block app:slot="title">
          <span th:text="#{admin.users.delete.title}">Confirm delete</span>
        </th:block>
        <th:block app:slot="body">
          <p th:text="#{admin.users.delete.confirm(${user.username})}">
            Delete this user?
          </p>
        </th:block>
        <th:block app:slot="fields">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <th:block th:replace="~{admin/users-fragments :: stateHiddenFields(${hiddenFieldsForActions})}"></th:block>
        </th:block>
        <th:block app:slot="cancel">
          <span th:text="#{admin.users.delete.cancel}">Cancel</span>
        </th:block>
        <th:block app:slot="confirm">
          <span th:text="#{admin.users.delete.confirmButton}">Delete</span>
        </th:block>
      </app:confirmation-dialog>
    </th:block>
  </div>
</section>
</html>
