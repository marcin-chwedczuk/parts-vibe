<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(~{::title}, ~{::section})}">
<head>
  <title th:text="#{admin.users.title}">User Management</title>
</head>
<section th:replace="~{layout/admin :: body(~{::div})}">
  <div>
    <h1 class="h4 mb-3" th:text="#{admin.users.heading}">User Management</h1>

    <div class="alert alert-success mb-3" th:if="${actionMessageCode != null}"
         th:text="#{__${actionMessageCode}__}">
      Action completed.
    </div>

    <div class="card mb-4">
      <div class="card-header" th:text="#{admin.users.filters.title}">Filters</div>
      <div class="card-body">
        <form method="get" th:action="@{/admin/users}">
          <input type="hidden" name="page" value="1" />
          <input type="hidden" name="size" th:value="${filters.size}" />
          <input type="hidden" name="sortBy" th:value="${filters.sortBy}" />
          <input type="hidden" name="sortDir" th:value="${filters.sortDir}" />
          <div class="row g-3 align-items-start">
            <div class="col-12 col-md-6 col-xl-3">
              <label class="form-label mb-1" for="usernameFilter" th:text="#{admin.users.filters.username}">
                Username
              </label>
              <input id="usernameFilter"
                     type="text"
                     class="form-control"
                     name="username"
                     th:value="${filters.username}" />
            </div>

            <div class="col-12 col-md-6 col-xl-3">
              <label class="form-label mb-1" for="enabledFilter" th:text="#{admin.users.filters.enabled}">
                Status
              </label>
              <select id="enabledFilter" class="form-select" name="enabled">
                <option value="all"
                        th:selected="${filters.enabled == 'all'}"
                        th:text="#{admin.users.filters.enabled.all}">All</option>
                <option value="enabled"
                        th:selected="${filters.enabled == 'enabled'}"
                        th:text="#{admin.users.filters.enabled.enabled}">Enabled</option>
                <option value="disabled"
                        th:selected="${filters.enabled == 'disabled'}"
                        th:text="#{admin.users.filters.enabled.disabled}">Disabled</option>
              </select>
            </div>

            <div class="col-12 col-md-6 col-xl-3">
              <label class="form-label mb-1" th:text="#{admin.users.filters.roles}">
                Roles
              </label>
              <div class="border rounded p-2 bg-body-tertiary">
                <div class="form-check" th:each="role : ${availableRoles}">
                  <input class="form-check-input"
                         type="checkbox"
                         name="roles"
                         th:id="|roleFilter-${role}|"
                         th:value="${role}"
                         th:checked="${filters.roles.contains(role)}" />
                  <label class="form-check-label" th:for="|roleFilter-${role}|"
                         th:text="${role}">ROLE_USER</label>
                </div>
              </div>
            </div>

            <div class="col-12 d-flex justify-content-end gap-2">
              <a class="btn btn-secondary" th:href="@{/admin/users}" th:text="#{admin.users.filters.clear}">
                Clear
              </a>
              <button type="submit" class="btn btn-primary" th:text="#{admin.users.filters.search}">
                Search
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-end mb-3 gap-3 flex-wrap">
      <form method="get" th:action="@{/admin/users}" class="d-flex align-items-center gap-2">
        <input type="hidden" name="page" value="1" />
        <th:block th:replace="~{admin/users-fragments :: stateHiddenFields(${hiddenFieldsForPageSize})}"></th:block>
        <label class="form-label mb-0 text-nowrap" for="sizeFilterTop" th:text="#{admin.users.filters.pageSize}">
          Page size
        </label>
        <select id="sizeFilterTop" class="form-select w-auto" name="size" onchange="this.form.submit()">
          <option th:each="pageSize : ${pageSizes}"
                  th:value="${pageSize}"
                  th:selected="${filters.size == pageSize}"
                  th:text="${pageSize}">10</option>
        </select>
      </form>

      <button type="button" class="btn btn-success">
        <i class="bi bi-plus-lg me-2" aria-hidden="true"></i>
        <span th:text="#{admin.users.actions.addUser}">Add User</span>
      </button>
    </div>

    <div class="table-responsive-md">
      <table class="table table-striped table-hover align-middle">
        <thead>
        <tr>
          <th scope="col">
            <a class="link-body-emphasis text-decoration-none" th:href="${sortUsername.url}">
              <span th:text="#{admin.users.grid.username}">Username</span>
              <th:block th:replace="~{admin/users-fragments :: sortIcon(${sortUsername})}"></th:block>
            </a>
          </th>
          <th scope="col">
            <a class="link-body-emphasis text-decoration-none" th:href="${sortEnabled.url}">
              <span th:text="#{admin.users.grid.enabled}">Status</span>
              <th:block th:replace="~{admin/users-fragments :: sortIcon(${sortEnabled})}"></th:block>
            </a>
          </th>
          <th scope="col" th:text="#{admin.users.grid.roles}">Roles</th>
          <th scope="col" class="text-end" th:text="#{admin.users.grid.actions}">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:if="${#lists.isEmpty(users)}">
          <td colspan="4" class="text-center text-muted py-4">
            <div th:text="#{admin.users.grid.empty}">No users found.</div>
            <small th:text="#{admin.users.grid.emptyHint}">Try changing filters.</small>
          </td>
        </tr>
        <tr th:each="user : ${users}">
          <td th:text="${user.username}">username</td>
          <td>
            <span class="badge text-bg-success" th:if="${user.enabled}" th:text="#{admin.users.status.enabled}">
              Enabled
            </span>
            <span class="badge text-bg-secondary" th:unless="${user.enabled}" th:text="#{admin.users.status.disabled}">
              Disabled
            </span>
          </td>
          <td th:text="${user.rolesDisplay()}">ROLE_USER</td>
          <td class="text-end">
            <div class="dropdown">
              <button class="btn btn-sm btn-link link-secondary text-decoration-none dropdown-toggle p-0"
                      type="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                      th:text="#{admin.users.grid.actions}">
                Actions
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li th:if="${user.enabled}">
                  <form method="post" class="m-0" th:action="@{/admin/users/{id}/do-lock(id=${user.id})}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <th:block th:replace="~{admin/users-fragments :: stateHiddenFields(${hiddenFieldsForActions})}"></th:block>
                    <button type="submit" class="dropdown-item">
                      <i class="bi bi-lock me-2" aria-hidden="true"></i>
                      <span th:text="#{admin.users.actions.lock}">Lock</span>
                    </button>
                  </form>
                </li>
                <li th:unless="${user.enabled}">
                  <form method="post" class="m-0" th:action="@{/admin/users/{id}/do-unlock(id=${user.id})}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <th:block th:replace="~{admin/users-fragments :: stateHiddenFields(${hiddenFieldsForActions})}"></th:block>
                    <button type="submit" class="dropdown-item">
                      <i class="bi bi-unlock me-2" aria-hidden="true"></i>
                      <span th:text="#{admin.users.actions.unlock}">Unlock</span>
                    </button>
                  </form>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <button type="button"
                          class="dropdown-item text-danger"
                          data-bs-toggle="modal"
                          th:attr="data-bs-target=|#delete-user-${user.id}|">
                    <i class="bi bi-trash me-2" aria-hidden="true"></i>
                    <span th:text="#{admin.users.actions.delete}">Delete</span>
                  </button>
                </li>
              </ul>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <nav class="d-flex justify-content-between align-items-center"
         aria-label="User management pages"
         th:if="${totalPages > 1}">
      <ul class="pagination mb-0">
        <li class="page-item" th:classappend="${filters.page == 1} ? ' disabled'">
          <a class="page-link" th:href="${paginationFirstUrl}" th:text="#{admin.users.pagination.first}">
            First
          </a>
        </li>

        <li class="page-item"
            th:each="pageLink : ${paginationPageLinks}"
            th:classappend="${filters.page == pageLink.pageNumber} ? ' active'">
          <a class="page-link" th:href="${pageLink.url}" th:text="${pageLink.pageNumber}">1</a>
        </li>

        <li class="page-item disabled" th:if="${totalPages > #lists.size(pageNumbers)}">
          <span class="page-link">...</span>
        </li>

        <li class="page-item" th:if="${totalPages > #lists.size(pageNumbers)}"
            th:classappend="${filters.page == totalPages} ? ' active'">
          <a class="page-link" th:href="${paginationLastUrl}" th:text="${totalPages}">10</a>
        </li>

        <li class="page-item" th:classappend="${filters.page == totalPages} ? ' disabled'">
          <a class="page-link" th:href="${paginationLastUrl}" th:text="#{admin.users.pagination.last}">
            Last
          </a>
        </li>
      </ul>

      <small class="text-muted" th:text="#{admin.users.pagination.summary(${startRow},${endRow},${totalRows})}">
        Showing 0-0 of 0
      </small>
    </nav>

    <div th:each="user : ${users}" class="modal fade" tabindex="-1" th:id="|delete-user-${user.id}|"
         th:attr="aria-labelledby=|delete-user-title-${user.id}|,aria-hidden='true'">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" th:id="|delete-user-title-${user.id}|" th:text="#{admin.users.delete.title}">
              Confirm delete
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" th:aria-label="#{admin.users.delete.cancel}"></button>
          </div>
          <div class="modal-body">
            <p class="mb-0"
               th:text="#{admin.users.delete.confirm(${user.username})}">
              Delete this user?
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"
                    th:text="#{admin.users.delete.cancel}">
              Cancel
            </button>
            <form method="post" class="m-0" th:action="@{/admin/users/{id}/do-delete(id=${user.id})}">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <th:block th:replace="~{admin/users-fragments :: stateHiddenFields(${hiddenFieldsForActions})}"></th:block>
              <button type="submit" class="btn btn-danger" th:text="#{admin.users.delete.confirmButton}">
                Delete
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
</html>
